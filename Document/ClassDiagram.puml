@startuml
scale 0.22
title EasySave v1.0 Class Diagram

skinparam classAttributeIconSize 0
skinparam linetype ortho
skinparam nodesep 80
skinparam ranksep 60
skinparam packageStyle rectangle
hide empty members

skinparam class {
  BackgroundColor<<interface>> LightBlue
  BackgroundColor<<port>> LightBlue
  BackgroundColor<<enumeration>> LightYellow
  BackgroundColor<<AggregateRoot>> #FFDAB9
  BackgroundColor<<Entity>> White
  BackgroundColor<<ValueObject>> Wheat
  BackgroundColor<<DomainService>> #E8D0FF
  BackgroundColor<<DTO>> #F0F0F0
  BorderColor Black
  ArrowColor Black
}

' ===== SHARED KERNEL =====
package "Shared Kernel" #F5F5F5 {

  enum Language <<enumeration>> {
    FR
    EN
  }

  enum LogFormat <<enumeration>> {
    JSON
    XML
  }
}

' ===== DOMAIN LAYER =====
package "Domain" #FEFECE {

  enum BackupType <<enumeration>> {
    FULL
    DIFFERENTIAL
  }

  enum JobState <<enumeration>> {
    INACTIVE
    ACTIVE
    END
    ERROR
  }

  class BackupJob <<AggregateRoot>> {
    - id: int
    - name: string
    - sourcePath: string
    - targetPath: string
    - type: BackupType
    - lastFullBackupDate: DateTime?
    - createdDate: DateTime
    + BackupJob(id: int, name: string,\n\t sourcePath: string, targetPath: string,\n\t type: BackupType)
    + GetId(): int
    + GetName(): string
    + GetSourcePath(): string
    + GetTargetPath(): string
    + GetType(): BackupType
    + GetLastFullBackupDate(): DateTime?
    + Validate(): void
    + IsFileModifiedSinceLastFull(file: FileDescriptor): bool
    + MarkFullBackupCompleted(date: DateTime): void
  }

  class FileDescriptor <<ValueObject>> {
    - path: string
    - size: long
    - lastModified: DateTime
    + FileDescriptor(path: string, size: long,\n\t lastModified: DateTime)
    + GetPath(): string
    + GetSize(): long
    + GetLastModified(): DateTime
    + Equals(other: object): bool
    + GetHashCode(): int
  }

  class BackupResult <<ValueObject>> {
    - success: bool
    - filesProcessed: int
    - bytesTransferred: long
    - duration: TimeSpan
    - errors: IReadOnlyList<string>
    + {static} Ok(filesProcessed: int,\n\t bytesTransferred: long,\n\t duration: TimeSpan): BackupResult
    + {static} Fail(errors: List<string>,\n\t duration: TimeSpan): BackupResult
    + IsSuccess(): bool
    + GetFilesProcessed(): int
    + GetBytesTransferred(): long
    + GetDuration(): TimeSpan
    + GetErrors(): IReadOnlyList<string>
  }

  interface IBackupStrategy <<interface>> {
    + SelectFiles(job: BackupJob,\n\t files: IReadOnlyList<FileDescriptor>):\n\t IReadOnlyList<FileDescriptor>
  }

  class FullBackupStrategy {
    + SelectFiles(job: BackupJob,\n\t files: IReadOnlyList<FileDescriptor>):\n\t IReadOnlyList<FileDescriptor>
  }

  class DifferentialBackupStrategy {
    + SelectFiles(job: BackupJob,\n\t files: IReadOnlyList<FileDescriptor>):\n\t IReadOnlyList<FileDescriptor>
  }

  class BackupDomainService <<DomainService>> {
    + ValidateJobLimit(currentCount: int,\n\t maxJobs: int): void
    + SelectFilesForBackup(job: BackupJob,\n\t files: IReadOnlyList<FileDescriptor>,\n\t strategy: IBackupStrategy):\n\t IReadOnlyList<FileDescriptor>
  }

  class DomainException {
    + DomainException(message: string)
  }

  class JobLimitExceededException {
    + JobLimitExceededException(max: int)
  }

  class InvalidBackupJobException {
    + InvalidBackupJobException(reason: string)
  }
}

' ===== APPLICATION LAYER =====
package "Application" #E8F5E9 {

  ' --- DTOs (Application concerns, not Domain) ---

  class StateSnapshot <<DTO>> {
    + Name: string
    + Timestamp: DateTime
    + State: JobState
    + TotalFilesCount: int
    + TotalFilesSize: long
    + Progress: int
    + RemainingFilesCount: int
    + RemainingFilesSize: long
    + CurrentSourceFilePath: string
    + CurrentTargetFilePath: string
  }

  class TransferLog <<DTO>> {
    + Timestamp: DateTime
    + BackupJobName: string
    + SourceFilePath: string
    + TargetFilePath: string
    + FileSize: long
    + TransferTimeMs: long
  }

  class JobExecutionResult <<DTO>> {
    + JobId: int
    + Result: BackupResult
  }

  ' --- Application Events (not Domain Events — infrastructure notification) ---

  class TransferCompletedEvent {
    + Transfer: TransferLog
    + TransferCompletedEvent(transfer: TransferLog)
  }

  class StateChangedEvent {
    + Snapshot: StateSnapshot
    + StateChangedEvent(snapshot: StateSnapshot)
  }

  interface IEventHandler<T> <<interface>> {
    + Handle(event: T): void
  }

  class TransferCompletedHandler {
    - logger: ITransferLogger
    + TransferCompletedHandler(logger: ITransferLogger)
    + Handle(event: TransferCompletedEvent): void
  }

  class StateChangedHandler {
    - stateManager: IStateManager
    + StateChangedHandler(stateManager: IStateManager)
    + Handle(event: StateChangedEvent): void
  }

  interface IEventBus <<port>> {
    + Publish<T>(event: T): void
    + Subscribe<T>(handler: IEventHandler<T>): void
  }

  ' --- Ports (Interfaces for Infrastructure) ---

  interface IJobRepository <<port>> {
    + Save(job: BackupJob): void
    + Delete(id: int): void
    + GetAll(): List<BackupJob>
    + GetById(id: int): BackupJob?
    + Update(job: BackupJob): void
    + Count(): int
  }

  interface IStateManager <<port>> {
    + UpdateState(snapshot: StateSnapshot): void
    + GetAllStates(): List<StateSnapshot>
    + ClearAll(): void
  }

  interface ITransferLogger <<port>> {
    + LogTransfer(log: TransferLog): void
  }

  interface IFileSystemGateway <<port>> {
    + EnumerateFiles(path: string): List<FileDescriptor>
    + EnsureDirectory(path: string): void
    + CopyFile(source: string, target: string): long
    + Exists(path: string): bool
  }

  interface IPathAdapter <<port>> {
    + ToUNC(path: string): string
    + IsValidPath(path: string): bool
  }

  interface ILanguageConfig <<port>> {
    + GetLanguage(): Language
    + SetLanguage(lang: Language): void
  }

  ' --- Application Services ---

  class ProgressTracker {
    - totalFiles: int
    - processedFiles: int
    - totalBytes: long
    - processedBytes: long
    + Initialize(files: List<FileDescriptor>): void
    + FileProcessed(file: FileDescriptor): void
    + BuildSnapshot(jobName: string): StateSnapshot
    + GetProgress(): int
    + Reset(): void
  }

  class BackupStrategyFactory <<factory>> {
    + Create(type: BackupType): IBackupStrategy
  }

  class BackupExecutor {
    - fileSystem: IFileSystemGateway
    - pathAdapter: IPathAdapter
    - eventBus: IEventBus
    - domainService: BackupDomainService
    - tracker: ProgressTracker
    + Execute(job: BackupJob,\n\t strategy: IBackupStrategy): BackupResult
  }

  class JobManagementService {
    - repository: IJobRepository
    - domainService: BackupDomainService
    + CreateJob(name: string, source: string,\n\t target: string, type: BackupType): BackupJob
    + ListJobs(): List<BackupJob>
    + DeleteJob(id: int): void
    + ModifyJob(id: int, name: string,\n\t source: string, target: string,\n\t type: BackupType): void
  }

  class BackupExecutionService {
    - repository: IJobRepository
    - executor: BackupExecutor
    - strategyFactory: BackupStrategyFactory
    + ExecuteJobs(jobIds: List<int>): List<JobExecutionResult>
    + ExecuteAllJobs(): List<JobExecutionResult>
  }

  class LanguageApplicationService {
    - languageConfig: ILanguageConfig
    + LanguageApplicationService(languageConfig: ILanguageConfig)
    + GetCurrentLanguage(): Language
    + ChangeLanguage(lang: Language): void
  }
}

' ===== EASYLOG (External DLL) =====
package "EasyLog (DLL)" #E0F7FA {

  interface IEasyLogger <<interface>> {
    + WriteInFile<T>(path: string, logData: T): void
  }

  class DailyLogsService {
    + WriteInFile<T>(path: string, logData: T): void
  }
}

' ===== INFRASTRUCTURE LAYER =====
package "Infrastructure" #E3F2FD {

  class FileJobRepository {
    - filePath: string
    + Save(job: BackupJob): void
    + Delete(id: int): void
    + GetAll(): List<BackupJob>
    + GetById(id: int): BackupJob?
    + Update(job: BackupJob): void
    + Count(): int
    - PersistToDisk(): void
    - LoadFromDisk(): void
  }

  class JsonStateManager {
    - filePath: string
    - states: List<StateSnapshot>
    + UpdateState(snapshot: StateSnapshot): void
    + GetAllStates(): List<StateSnapshot>
    + ClearAll(): void
  }

  class JsonTransferLogger {
    - logDirectory: string
    - easyLogger: IEasyLogger
    + LogTransfer(log: TransferLog): void
    - GetDailyLogPath(): string
  }

  class XmlTransferLogger {
    - logDirectory: string
    - easyLogger: IEasyLogger
    + LogTransfer(log: TransferLog): void
    - GetDailyLogPath(): string
  }

  class LocalFileSystemGateway {
    + EnumerateFiles(path: string): List<FileDescriptor>
    + EnsureDirectory(path: string): void
    + CopyFile(source: string, target: string): long
    + Exists(path: string): bool
  }

  class UNCPathAdapter {
    + ToUNC(path: string): string
    + IsValidPath(path: string): bool
  }

  class AppConfiguration {
    - configPath: string
    - logFormat: LogFormat
    - language: Language
    - logDirectory: string
    + GetLogFormat(): LogFormat
    + SetLogFormat(format: LogFormat): void
    + GetLanguage(): Language
    + SetLanguage(lang: Language): void
    + GetLogDirectory(): string
    + Load(): void
    + Save(): void
  }

  class TransferLoggerFactory <<factory>> {
    - config: AppConfiguration
    - easyLogger: IEasyLogger
    + Create(): ITransferLogger
  }

  class InProcessEventBus {
    - handlers: Dictionary<Type, List<object>>
    + Publish<T>(event: T): void
    + Subscribe<T>(handler: IEventHandler<T>): void
  }
}

' ===== PRESENTATION LAYER (CLI) =====
package "Presentation (CLI)" #FFF3E0 {

  class CommandResult <<ValueObject>> {
    - success: bool
    - errorMessage: string
    + {static} Ok(): CommandResult
    + {static} Fail(message: string): CommandResult
    + IsSuccess(): bool
    + GetErrorMessage(): string
  }

  interface ICommand <<interface>> {
    + Execute(args: List<string>): CommandResult
  }

  class CreateJobCommand {
    - jobService: JobManagementService
    + Execute(args: List<string>): CommandResult
  }

  class ExecuteJobCommand {
    - executionService: BackupExecutionService
    + Execute(args: List<string>): CommandResult
  }

  class DeleteJobCommand {
    - jobService: JobManagementService
    + Execute(args: List<string>): CommandResult
  }

  class ListJobsCommand {
    - jobService: JobManagementService
    + Execute(args: List<string>): CommandResult
  }

  class ModifyJobCommand {
    - jobService: JobManagementService
    + Execute(args: List<string>): CommandResult
  }

  class ChangeLanguageCommand {
    - languageService: LanguageApplicationService
    + Execute(args: List<string>): CommandResult
  }

  class ExitCommand {
    + Execute(args: List<string>): CommandResult
  }

  class InputParser <<utility>> {
    + ParseJobRange(input: string): List<int>
    + ParseJobList(input: string): List<int>
  }

  class LanguageManager {
    - languageService: LanguageApplicationService
    - resources: Dictionary<string, Dictionary<Language, string>>
    + LanguageManager(languageService: LanguageApplicationService)
    + GetString(key: string): string
    + GetCurrentLanguage(): Language
  }

  class ConsoleUI {
    - languageManager: LanguageManager
    - inputParser: InputParser
    - commands: Dictionary<string, ICommand>
    + Run(): void
    - ShowMenu(): void
    - ReadInput(): string
    - DispatchCommand(name: string,\n\t args: List<string>): void
  }
}

' ===== COMPOSITION ROOT =====
package "Composition Root" #F3E5F5 {

  class Program {
    + {static} Main(args: string[]): void
    - {static} ConfigureServices(): void
  }
}

' ========================================================
' RELATIONS
' ========================================================

' --- Domain internal ---
IBackupStrategy <|.. FullBackupStrategy
IBackupStrategy <|.. DifferentialBackupStrategy
BackupJob "1" --> "1" BackupType : has
DifferentialBackupStrategy ..> BackupJob : calls IsFileModifiedSinceLastFull()
BackupDomainService ..> BackupJob : validates
BackupDomainService ..> IBackupStrategy : delegates to
BackupDomainService ..> FileDescriptor : filters
DomainException <|-- JobLimitExceededException
DomainException <|-- InvalidBackupJobException
BackupJob ..> InvalidBackupJobException : throws
BackupDomainService ..> JobLimitExceededException : throws

' --- Application: BackupExecutor publishes events, does NOT call loggers/state directly ---
BackupExecutor "1" --> "1" IFileSystemGateway : reads/copies via
BackupExecutor "1" --> "1" IPathAdapter : converts paths via
BackupExecutor "1" --> "1" IEventBus : publishes events via
BackupExecutor "1" --> "1" BackupDomainService : delegates selection to
BackupExecutor "1" --> "1" ProgressTracker : tracks progress with
BackupExecutor ..> BackupJob : receives
BackupExecutor ..> BackupResult : returns
BackupExecutor ..> FileDescriptor : processes
BackupExecutor ..> TransferCompletedEvent : publishes
BackupExecutor ..> StateChangedEvent : publishes
BackupExecutor ..> IBackupStrategy : receives

' --- Application: Event handlers (typed, no runtime cast) ---
"IEventHandler<TransferCompletedEvent>" <|.. TransferCompletedHandler
"IEventHandler<StateChangedEvent>" <|.. StateChangedHandler
TransferCompletedHandler "1" --> "1" ITransferLogger : logs via
StateChangedHandler "1" --> "1" IStateManager : persists via
TransferCompletedEvent "1" *-- "1" TransferLog : carries
StateChangedEvent "1" *-- "1" StateSnapshot : carries

' --- Application: Services ---
JobManagementService "1" --> "1" IJobRepository : persists via
JobManagementService "1" --> "1" BackupDomainService : validates with

BackupExecutionService "1" --> "1" IJobRepository : reads from
BackupExecutionService "1" --> "1" BackupExecutor : delegates to
BackupExecutionService "1" --> "1" BackupStrategyFactory : resolves strategy via
BackupExecutionService ..> JobExecutionResult : returns

ProgressTracker ..> FileDescriptor : tracks
ProgressTracker ..> StateSnapshot : builds

BackupStrategyFactory ..> IBackupStrategy : creates
BackupStrategyFactory ..> BackupType : receives
JobExecutionResult "1" *-- "1" BackupResult : carries
StateSnapshot "1" --> "1" JobState : has

' --- EasyLog DLL ---
IEasyLogger <|.. DailyLogsService

' --- Infrastructure implements Ports ---
IJobRepository <|.. FileJobRepository
IStateManager <|.. JsonStateManager
ITransferLogger <|.. JsonTransferLogger
ITransferLogger <|.. XmlTransferLogger
IFileSystemGateway <|.. LocalFileSystemGateway
IPathAdapter <|.. UNCPathAdapter
ILanguageConfig <|.. AppConfiguration

JsonTransferLogger "1" --> "1" IEasyLogger : delegates to
XmlTransferLogger "1" --> "1" IEasyLogger : delegates to

IEventBus <|.. InProcessEventBus
InProcessEventBus "1" o-- "0..*" "IEventHandler<T>" : registers

TransferLoggerFactory "1" --> "1" AppConfiguration : reads format from
TransferLoggerFactory "1" --> "1" IEasyLogger : injects into loggers
TransferLoggerFactory ..> ITransferLogger : creates

AppConfiguration "1" --> "1" LogFormat : stores
AppConfiguration "1" --> "1" Language : stores

FileJobRepository "1" *-- "0..*" BackupJob : stores
JsonStateManager "1" *-- "*" StateSnapshot : stores

' --- Presentation ---
ICommand <|.. CreateJobCommand
ICommand <|.. ExecuteJobCommand
ICommand <|.. DeleteJobCommand
ICommand <|.. ListJobsCommand
ICommand <|.. ModifyJobCommand
ICommand <|.. ChangeLanguageCommand
ICommand <|.. ExitCommand

ConsoleUI "1" o-- "1..*" ICommand : dispatches to
ConsoleUI "1" --> "1" InputParser : parses input with
ConsoleUI "1" --> "1" LanguageManager : translates with

CreateJobCommand "1" --> "1" JobManagementService : calls
ExecuteJobCommand "1" --> "1" BackupExecutionService : calls
DeleteJobCommand "1" --> "1" JobManagementService : calls
ListJobsCommand "1" --> "1" JobManagementService : calls
ModifyJobCommand "1" --> "1" JobManagementService : calls
ChangeLanguageCommand "1" --> "1" LanguageApplicationService : changes language via
LanguageApplicationService "1" --> "1" ILanguageConfig : reads/persists via
LanguageManager "1" --> "1" LanguageApplicationService : reads current language via
LanguageManager ..> Language : uses type

' --- Composition Root ---
Program ..> ConsoleUI : assembles
Program ..> JobManagementService : assembles
Program ..> BackupExecutionService : assembles
Program ..> BackupExecutor : assembles
Program ..> LanguageApplicationService : assembles
Program ..> AppConfiguration : loads
Program ..> TransferLoggerFactory : uses
Program ..> InProcessEventBus : assembles
Program ..> TransferCompletedHandler : assembles
Program ..> StateChangedHandler : assembles


' ========================================================
' NOTES
' ========================================================

note right of BackupJob
  **Aggregate Root**: protects business invariants only.
  Validate() throws InvalidBackupJobException if:
  - name is empty
  - source or target path is empty
  - source == target
  Technical path validation (syntax, UNC format)
  is handled by IPathAdapter (infrastructure concern).
  IsFileModifiedSinceLastFull() encapsulates the
  differential backup business rule using
  the entity's own lastFullBackupDate state.
end note

note bottom of IBackupStrategy
  **Strategy pattern**: polymorphic file selection.
  FullBackupStrategy returns all files.
  DifferentialBackupStrategy delegates to
  BackupJob.IsFileModifiedSinceLastFull()
  for each file, keeping domain logic in the entity.
end note

note bottom of FileDescriptor
  **Immutable Value Object**.
  Equality defined by Path + Size + LastModified.
  No identity — two descriptors with same
  values are considered equal.
end note

note right of BackupDomainService
  **Stateless Domain Service**.
  ValidateJobLimit() enforces MAX_JOBS rule
  (configurable, not hardcoded in entity).
  Orchestrates strategy-based file selection.
end note

note bottom of StateSnapshot
  Application-layer DTO, not a domain concept.
  Represents the serializable state for
  real-time progress reporting.
  Persisted immediately on each update
  (no separate Save() call needed).
end note

note bottom of TransferLog
  Application-layer DTO for log entries.
  No EncryptionTimeMs in v1.0 (YAGNI).
  Will be extended in v2.0 when CryptoSoft
  integration is added.
end note

note bottom of IEventBus
  **Typed event bus**: Publish<T>/Subscribe<T>
  use generics; callers and handlers do not
  perform runtime casts.
  IEventHandler<T>.Handle(event: T) is type-safe.
  Trade-off: dispatch infrastructure may still
  use internal casts (hidden from API consumers),
  unlike the original IDomainEvent + cast approach.
end note

note bottom of InProcessEventBus
  **Open/Closed**: generic Dictionary<Type, List>
  allows adding new event types and multiple
  handlers per type without modifying the bus.
  Subscribe<T>() registers, Publish<T>() resolves
  and dispatches. Trade-off: internal cast from
  object to IEventHandler<T> at runtime, but the
  public API remains fully type-safe.
end note

note right of ITransferLogger
  **Interface Segregation**: single responsibility.
  Only LogTransfer(). No SetLogPath() or Close().
  File path management is an infrastructure
  concern handled internally by implementations.
end note

note bottom of JsonStateManager
  UpdateState() persists to disk immediately
  (real-time requirement from specification).
  No separate Save() method needed.
end note

@enduml