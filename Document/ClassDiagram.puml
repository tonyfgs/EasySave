@startuml
scale 0.22
title EasySave v1.0 Class Diagram - DDD / Clean Architecture (Final)

skinparam classAttributeIconSize 0
skinparam linetype ortho
skinparam nodesep 80
skinparam ranksep 60
skinparam packageStyle rectangle
hide empty members

skinparam class {
  BackgroundColor<<interface>> LightBlue
  BackgroundColor<<port>> LightBlue
  BackgroundColor<<singleton>> LightGreen
  BackgroundColor<<enumeration>> LightYellow
  BackgroundColor<<facade>> LightCoral
  BackgroundColor<<marker>> LightGray
  BackgroundColor<<Entity>> White
  BackgroundColor<<ValueObject>> Wheat
  BorderColor Black
  ArrowColor Black
}

' ===== SHARED KERNEL =====
package "Shared Kernel" #F5F5F5 {

  enum Language <<enumeration>> {
    FR
    EN
  }

  enum LogFormat <<enumeration>> {
    JSON
    XML
  }
}

' ===== DOMAIN LAYER =====
package "Domain" #FEFECE {

  enum BackupType <<enumeration>> {
    FULL
    DIFFERENTIAL
  }

  enum JobState <<enumeration>> {
    INACTIVE
    ACTIVE
    END
  }

  class BackupJob <<Entity>> {
    + {static} MAX_JOBS: int = 5
    - id: int
    - name: string
    - sourcePath: string
    - targetPath: string
    - type: BackupType
    - lastFullBackupDate: DateTime
    - createdDate: DateTime
    - modifiedDate: DateTime
    + GetId(): int
    + GetName(): string
    + GetSourcePath(): string
    + GetTargetPath(): string
    + GetType(): BackupType
    + UpdateLastFullBackup(date: DateTime): void
  }

  class FileDescriptor <<ValueObject>> {
    + Path: string
    + Size: long
    + LastModified: DateTime
  }

  class BackupResult <<ValueObject>> {
    + Success: bool
    + Message: string
    + FilesProcessed: int
    + BytesTransferred: long
    + Duration: TimeSpan
    + Errors: IReadOnlyList<string>
  }

  class StateInfo <<ValueObject>> {
    + Name: string
    + Timestamp: DateTime
    + State: JobState
    + TotalFilesCount: int
    + TotalFilesSize: long
    + Progress: int
    + RemainingFilesCount: int
    + RemainingFilesSize: long
    + CurrentSourceFilePath: string
    + CurrentTargetFilePath: string
  }

  class TransferInfo <<ValueObject>> {
    + Timestamp: DateTime
    + BackupJobName: string
    + SourceFilePath: string
    + TargetFilePath: string
    + FileSize: long
    + TransferTimeMs: long
    + EncryptionTimeMs: long
  }

  interface IDomainEvent <<marker>> {
  }

  class StateChangedEvent {
    + State: StateInfo
  }

  class TransferCompletedEvent {
    + Transfer: TransferInfo
  }

  interface IBackupStrategy <<interface>> {
    + SelectFiles(files: List<FileDescriptor>,\n\t lastFullBackupDate: DateTime): List<FileDescriptor>
  }

  class FullBackupStrategy {
    + SelectFiles(files: List<FileDescriptor>,\n\t lastFullBackupDate: DateTime): List<FileDescriptor>
  }

  class DifferentialBackupStrategy {
    + SelectFiles(files: List<FileDescriptor>,\n\t lastFullBackupDate: DateTime): List<FileDescriptor>
  }
}

' ===== APPLICATION LAYER =====
package "Application" #E8F5E9 {

  ' --- Ports ---

  interface IJobRepository <<port>> {
    + Save(job: BackupJob): void
    + Delete(id: int): void
    + GetAll(): List<BackupJob>
    + GetById(id: int): BackupJob
    + Update(job: BackupJob): void
  }

  interface IStateStore <<port>> {
    + UpdateState(state: StateInfo): void
    + GetCurrentState(): List<StateInfo>
    + Save(): void
    + Clear(): void
  }

  interface ILogger <<port>> {
    + Log(info: TransferInfo): void
    + SetLogPath(path: string): void
    + Close(): void
  }

  interface IFileSystemGateway <<port>> {
    + EnumerateFiles(path: string): List<FileDescriptor>
    + EnsureDirectory(path: string): bool
    + CopyFile(source: string, target: string): bool
    + Exists(path: string): bool
  }

  interface IPathAdapter <<port>> {
    + ConvertToUNC(path: string): string
    + ConvertFromUNC(path: string): string
    + IsValidPath(path: string): bool
  }

  interface IBackupStrategyFactory <<port>> {
    + Create(type: BackupType): IBackupStrategy
  }

  interface IEventPublisher <<port>> {
    + Publish(event: IDomainEvent): void
    + Subscribe(handler: IDomainEventHandler): void
  }

  ' --- Event Handlers ---

  interface IDomainEventHandler <<interface>> {
    + Handle(event: IDomainEvent): void
  }

  class TransferCompletedEventHandler {
    - logger: ILogger
    + TransferCompletedEventHandler(logger: ILogger)
    + Handle(event: IDomainEvent): void
  }

  class StateChangedEventHandler {
    - stateStore: IStateStore
    + StateChangedEventHandler(stateStore: IStateStore)
    + Handle(event: IDomainEvent): void
  }

  ' --- ProgressTracker ---

  class ProgressTracker {
    - totalFiles: int
    - processedFiles: int
    - totalBytes: long
    - processedBytes: long
    + Initialize(files: List<FileDescriptor>): void
    + UpdateProgress(file: FileDescriptor): void
    + BuildState(jobName: string): StateInfo
    + GetProgress(): int
    + GetRemainingFiles(): int
    + GetRemainingBytes(): long
    + Reset(): void
  }

  ' --- BackupOrchestrator (single-job execution) ---

  class BackupOrchestrator {
    - fileSystem: IFileSystemGateway
    - pathAdapter: IPathAdapter
    - strategyFactory: IBackupStrategyFactory
    - eventPublisher: IEventPublisher
    - tracker: ProgressTracker
    + Execute(job: BackupJob): BackupResult
    - EnumerateSourceFiles(sourcePath: string): List<FileDescriptor>
    - SelectFilesToBackup(job: BackupJob,\n\t files: List<FileDescriptor>): List<FileDescriptor>
    - CopyFiles(files: List<FileDescriptor>,\n\t job: BackupJob): void
    - PublishTransferCompleted(job: BackupJob,\n\t file: FileDescriptor, transferTimeMs: long): void
    - PublishStateChanged(job: BackupJob): void
  }

  ' --- BackupApplicationService (multi-job coordination) ---

  class BackupApplicationService {
    - repository: IJobRepository
    - orchestrator: BackupOrchestrator
    + CreateJob(name: string, source: string,\n\t target: string, type: BackupType): void
    + ExecuteJobs(jobIds: List<int>): List<BackupResult>
    + ListJobs(): List<BackupJob>
    + DeleteJob(id: int): void
    + ModifyJob(id: int, job: BackupJob): void
  }
}

' ===== EASYLOG (External DLL) =====
package "EasyLog (DLL)" #E0F7FA {

  interface IEasyLogger <<interface>> {
    + WriteInFile<T>(path: string, logData: T): void
  }

  class DailyLogsService {
    + WriteInFile<T>(path: string, logData: T): void
  }

  class LogData {
    + Timestamp: string
    + BackupJobName: string
    + SourceFilePath: string
    + TargetFilePath: string
    + FileSize: long
    + TransferTimeMs: long
    + EncryptionTimeMs: long
  }
}

' ===== INFRASTRUCTURE LAYER =====
package "Infrastructure" #E3F2FD {

  class FileJobRepository {
    - filePath: string
    - syncLock: object
    + Save(job: BackupJob): void
    + Delete(id: int): void
    + GetAll(): List<BackupJob>
    + GetById(id: int): BackupJob
    + Update(job: BackupJob): void
    - PersistJobs(): void
    - LoadJobs(): void
  }

  class FileStateStore {
    - filePath: string
    - states: List<StateInfo>
    - syncLock: object
    + UpdateState(state: StateInfo): void
    + GetCurrentState(): List<StateInfo>
    + Save(): void
    + Clear(): void
  }

  class JsonLogger {
    - filePath: string
    - easyLogger: IEasyLogger
    + Log(info: TransferInfo): void
    + SetLogPath(path: string): void
    + Close(): void
  }

  class XmlLogger {
    - filePath: string
    + Log(info: TransferInfo): void
    + SetLogPath(path: string): void
    + Close(): void
  }

  class LocalFileSystemGateway {
    + EnumerateFiles(path: string): List<FileDescriptor>
    + EnsureDirectory(path: string): bool
    + CopyFile(source: string, target: string): bool
    + Exists(path: string): bool
  }

  class CanonicalPathAdapter {
    + ConvertToUNC(path: string): string
    + ConvertFromUNC(path: string): string
    + IsValidPath(path: string): bool
  }

  class BackupStrategyFactory {
    + Create(type: BackupType): IBackupStrategy
  }

  class InProcessEventPublisher {
    - handlers: List<IDomainEventHandler>
    + Publish(event: IDomainEvent): void
    + Subscribe(handler: IDomainEventHandler): void
  }

  class ConfigurationManager {
    - configPath: string
    + GetLogFormat(): LogFormat
    + SetLogFormat(format: LogFormat): void
    + GetLanguage(): Language
    + SetLanguage(lang: Language): void
    + GetLogPath(): string
    + SetLogPath(path: string): void
    + Save(): void
    + Load(): void
  }

  class LoggerFactory {
    - configManager: ConfigurationManager
    + CreateLogger(): ILogger
  }
}

' ===== PRESENTATION LAYER (CLI) =====
package "Presentation (CLI)" #FFF3E0 {

  class ParsedCommand {
    + CommandName: string
    + Arguments: List<string>
    + IsValid: bool
    + ErrorMessage: string
  }

  interface ICommand <<interface>> {
    + Execute(command: ParsedCommand): void
    + CanExecute(command: ParsedCommand): bool
  }

  class CreateJobCommand {
    - appService: BackupApplicationService
    + Execute(command: ParsedCommand): void
    + CanExecute(command: ParsedCommand): bool
  }

  class ExecuteJobCommand {
    - appService: BackupApplicationService
    + Execute(command: ParsedCommand): void
    + CanExecute(command: ParsedCommand): bool
  }

  class DeleteJobCommand {
    - appService: BackupApplicationService
    + Execute(command: ParsedCommand): void
    + CanExecute(command: ParsedCommand): bool
  }

  class ListJobsCommand {
    - appService: BackupApplicationService
    + Execute(command: ParsedCommand): void
    + CanExecute(command: ParsedCommand): bool
  }

  class ModifyJobCommand {
    - appService: BackupApplicationService
    + Execute(command: ParsedCommand): void
    + CanExecute(command: ParsedCommand): bool
  }

  class ChangeLanguageCommand {
    - languageManager: LanguageManager
    + Execute(command: ParsedCommand): void
    + CanExecute(command: ParsedCommand): bool
  }

  class ExitCommand {
    + Execute(command: ParsedCommand): void
    + CanExecute(command: ParsedCommand): bool
  }

  class CommandLineParser {
    + Parse(args: string[]): ParsedCommand
    + ParseJobRange(arg: string): List<int>
    + ParseJobList(arg: string): List<int>
  }

  class LanguageManager {
    - currentLanguage: Language
    - resources: Dictionary<string, Dictionary<Language, string>>
    + GetString(key: string): string
    + SetLanguage(lang: Language): void
    + GetCurrentLanguage(): Language
  }

  class ConsoleUI {
    - parser: CommandLineParser
    - languageManager: LanguageManager
    - commands: Dictionary<string, ICommand>
    + Run(): void
    + ShowMenu(): void
    + GetUserInput(): string
    - ProcessCommand(command: ParsedCommand): void
  }
}

' ===== COMPOSITION ROOT =====
package "Composition Root" #F3E5F5 {

  class Program {
    + {static} Main(args: string[]): void
    - {static} BuildCompositionRoot(): void
  }
}

' ===== RELATIONS: Domain =====
IDomainEvent <|.. StateChangedEvent
IDomainEvent <|.. TransferCompletedEvent
IBackupStrategy <|.. FullBackupStrategy
IBackupStrategy <|.. DifferentialBackupStrategy
BackupJob --> BackupType
StateInfo --> JobState
StateChangedEvent --> StateInfo
TransferCompletedEvent --> TransferInfo

' ===== RELATIONS: Application =====
IDomainEventHandler <|.. TransferCompletedEventHandler
IDomainEventHandler <|.. StateChangedEventHandler
TransferCompletedEventHandler --> ILogger
StateChangedEventHandler --> IStateStore

BackupOrchestrator --> IFileSystemGateway
BackupOrchestrator --> IPathAdapter
BackupOrchestrator --> IBackupStrategyFactory
BackupOrchestrator --> IEventPublisher
BackupOrchestrator --> ProgressTracker
BackupOrchestrator --> BackupJob
BackupOrchestrator --> BackupResult
BackupOrchestrator --> FileDescriptor

BackupApplicationService --> IJobRepository
BackupApplicationService --> BackupOrchestrator

ProgressTracker --> FileDescriptor
ProgressTracker --> StateInfo

' ===== RELATIONS: EasyLog DLL =====
IEasyLogger <|.. DailyLogsService
DailyLogsService --> LogData

' ===== RELATIONS: Infrastructure implements Ports =====
IJobRepository <|.. FileJobRepository
IStateStore <|.. FileStateStore
ILogger <|.. JsonLogger
ILogger <|.. XmlLogger
IFileSystemGateway <|.. LocalFileSystemGateway
IPathAdapter <|.. CanonicalPathAdapter
IBackupStrategyFactory <|.. BackupStrategyFactory
IEventPublisher <|.. InProcessEventPublisher

JsonLogger --> IEasyLogger : delegates to

InProcessEventPublisher "1" o-- "*" IDomainEventHandler
BackupStrategyFactory ..> IBackupStrategy : creates
LoggerFactory --> ConfigurationManager
LoggerFactory ..> ILogger : creates
ConfigurationManager --> LogFormat
ConfigurationManager --> Language

' ===== RELATIONS: Presentation =====
ICommand <|.. CreateJobCommand
ICommand <|.. ExecuteJobCommand
ICommand <|.. DeleteJobCommand
ICommand <|.. ListJobsCommand
ICommand <|.. ModifyJobCommand
ICommand <|.. ChangeLanguageCommand
ICommand <|.. ExitCommand

ConsoleUI "1" o-- "*" ICommand
ConsoleUI --> CommandLineParser
ConsoleUI --> LanguageManager
CommandLineParser --> ParsedCommand

CreateJobCommand --> BackupApplicationService
ExecuteJobCommand --> BackupApplicationService
DeleteJobCommand --> BackupApplicationService
ListJobsCommand --> BackupApplicationService
ModifyJobCommand --> BackupApplicationService
ChangeLanguageCommand --> LanguageManager
LanguageManager --> Language

' ===== RELATIONS: Composition Root =====
Program --> ConsoleUI
Program --> BackupApplicationService
Program --> BackupOrchestrator
Program --> ConfigurationManager
Program --> LoggerFactory
Program --> InProcessEventPublisher
Program --> TransferCompletedEventHandler
Program --> StateChangedEventHandler

' ===== NOTES =====
note right of CanonicalPathAdapter
  Stateless, thread-safe.
  Normalizes paths (env vars, relative -> absolute, separators).
  Detects UNC vs local paths automatically.
end note

note bottom of IBackupStrategy
  Strategy pattern: selects files
  based on backup type (full vs differential).
end note

note bottom of FileDescriptor
  Value Object: immutable.
  Represents a file to backup.
end note

@enduml
